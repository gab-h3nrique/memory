import path from "path";
import handler from "../utils/handler";
import failsController from "./failController";
import MessageController from "./whatsapp/messageController";
import UserController from "./user/userController";
import jwt from "jsonwebtoken";
import WhaatsappController from "./whatsapp/whatsappController";
//////
//////
//////
//////
export default function routes(app) {

    app.post('/login', handler.error(UserController.login))
    app.post('/signup', handler.error(UserController.signup))

    middleware(app, () => {

        /////// FAIL ROUTES ///////
        app.get('/fail', handler.error(failsController.get))
        app.post('/fail', handler.error(failsController.post))
        app.delete('/fail', handler.error(failsController.delete))
        /////// FAIL ROUTES ///////
    
        /////// USER ROUTES ///////
        app.get('/user', handler.error(UserController.get))
        app.post('/user', handler.error(UserController.post))
        app.delete('/user', handler.error(UserController.delete))
        /////// USER ROUTES ///////

        /////// ACCOUNT WHATSAPP ROUTES ///////
        app.get('/account/whatsapp', handler.error(WhaatsappController.get))
        app.post('/account/whatsapp', handler.error(WhaatsappController.post))
        app.delete('/account/whatsapp', handler.error(WhaatsappController.delete))

        // app.delete('/account/whatsapp/includeUser', handler.error(WhaatsappController.delete))
        app.post('/account/whatsapp/message', handler.error(WhaatsappController.sendMessage))
        app.get('/account/whatsapp/qrcode', handler.error(WhaatsappController.qrCode))
        /////// ACCOUNT WHATSAPP ROUTES ///////

    })

}
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////// MIDDLEWARE TO VERIFY TOKEN ////////////////////////////////////
function middleware(app, call) {

    app.use(async(req, res, next) => {

        const verify = await verifyToken(req)

        if(!verify) return res.status(401).json({ success: false, data: null, message: 'Unauthorized' })

        next()

        call()

    })

}
//////////
//////////
//////////
//////////
//////////
//////////
async function verifyToken(req) {

    try {
        
        const authHeader = req.headers['authorization']
    
        const token = authHeader && authHeader.split(' ')[1]
    
        const decoded = await jwt.verify(token, process.env.ACCESS_TOKEN || 'GARREN')
    
        if(!decoded) return false
    
        return true

    } catch (error) {

        return false
        
    }


}
//////////
//////////
//////////
//////////
//////////
//////////
export async function Auth(req) {

    try {
        
        const authHeader = req.headers['authorization']
    
        const token = authHeader && authHeader.split(' ')[1]
    
        const decoded = await jwt.verify(token, process.env.ACCESS_TOKEN || 'GARREN')
    
        if(!decoded) return { user: null, token: null }
    
        return { user: decoded, token }

    } catch (error) {

        return { user: null, token: null }
        
    }

}
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////